<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>Admin Dashboard</title>
    <link rel="stylesheet" th:href="@{/css/admin.css}">
</head>
<body>

<div class="sidebar">
    <h2>Admin</h2>
    <a th:href="@{/user/login_success}">Back to Home</a>
    <a th:href="@{/admin}" class="active">Users</a>
    <a th:href="@{/stations}">Stations</a>
    <a th:href="@{/lines}">Lines</a>
    <a th:href="@{/buses}">Buses</a>
    <a th:href="@{/admin/sales-points}">Sales Points</a>

    <form th:action="@{/logout}" method="post" class="logout-form">
        <button type="submit" class="sidebar-link">Logout</button>
    </form>

</div>

<div class="content">
    <h1>User Management</h1>

    <div class="admin-tools" style="margin: 20px 0; padding: 16px; border: 1px solid #ddd; border-radius: 8px;">
        <h2 style="margin-top:0;">Schedules tools</h2>

        <button id="regenStopsBtn" class="btn" type="button">
            üîÅ Regenerate schedule_stops (ALL)
        </button>

        <span id="regenStatus" style="margin-left:12px;"></span>
    </div>

    <script>
        const btn = document.getElementById("regenStopsBtn");
        const status = document.getElementById("regenStatus");

        btn.addEventListener("click", async () => {
          if (!confirm("Ovo ƒáe obrisati i ponovno generirati schedule_stops za sve schedules. Nastaviti?")) return;

          btn.disabled = true;
          status.textContent = "‚è≥ regeneriram...";

          try {
            const res = await fetch("/admin/schedules/regenerate-stops", {
              method: "POST",
              credentials: "same-origin",
              headers: { "X-Requested-With": "XMLHttpRequest" }
            });

            const text = await res.text();

            if (!res.ok) {
              status.textContent = `‚ùå ${res.status}: ${text}`;
              return;
            }

            status.textContent = "‚úÖ " + text;
          } catch (e) {
            console.error(e);
            status.textContent = "‚ùå " + (e?.message ?? e);
          } finally {
            btn.disabled = false;
          }
        });
    </script>



    <table class="styled-table">
        <thead>
        <tr>
            <th>ID</th>
            <th>Name</th>
            <th>Email</th>
            <th>Role</th>
            <th style="width: 180px;">Actions</th>
        </tr>
        </thead>

        <tbody>
        <tr th:each="user : ${users}">
            <td th:text="${user.id}"></td>
            <td th:text="${user.name}"></td>
            <td th:text="${user.email}"></td>
            <td th:text="${user.role}"></td>
            <td>
                <form th:action="@{/admin/changeRole}" method="post" class="role-form">
                    <input type="hidden" name="userId" th:value="${user.id}" />

                    <select name="role" class="role-select">
                        <option value="USER" th:selected="${user.role=='USER'}">User</option>
                        <option value="ADMIN" th:selected="${user.role=='ADMIN'}">Admin</option>
                    </select>

                    <button type="submit" class="btn">Save</button>
                </form>
            </td>
        </tr>
        </tbody>
    </table>
</div>

</body>
</html>
